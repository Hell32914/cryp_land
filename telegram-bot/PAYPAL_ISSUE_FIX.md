# Р”РёР°РіРЅРѕСЃС‚РёРєР° Рё РёСЃРїСЂР°РІР»РµРЅРёРµ РїСЂРѕР±Р»РµРјС‹ PayPal

## РџСЂРѕР±Р»РµРјР°
Р”РµРЅСЊРіРё СЃ РєР°СЂС‚С‹ СЃРїРёСЃР°Р»РёСЃСЊ, РЅРѕ Р±Р°Р»Р°РЅСЃ РІ Р±РѕС‚Рµ РЅРµ РїРѕРїРѕР»РЅРёР»СЃСЏ Рё СѓРІРµРґРѕРјР»РµРЅРёРµ РЅРµ РїСЂРёС€Р»Рѕ.

## Р’РѕР·РјРѕР¶РЅС‹Рµ РїСЂРёС‡РёРЅС‹
1. вќЊ Webhook РѕС‚ PayPal РЅРµ РЅР°СЃС‚СЂРѕРµРЅ РёР»Рё РЅРµ СЂР°Р±РѕС‚Р°РµС‚
2. вќЊ Webhook РїРѕР»СѓС‡РµРЅ, РЅРѕ РїСЂРѕРёР·РѕС€Р»Р° РѕС€РёР±РєР° РїСЂРё РѕР±СЂР°Р±РѕС‚РєРµ
3. вќЊ РџР»Р°С‚РµР¶ РІ СЃС‚Р°С‚СѓСЃРµ APPROVED, РЅРѕ РЅРµ Р·Р°С…РІР°С‡РµРЅ (captured)
4. вќЊ РџСЂРѕР±Р»РµРјР° СЃ СЃРѕРµРґРёРЅРµРЅРёРµРј РјРµР¶РґСѓ PayPal Рё РІР°С€РёРј СЃРµСЂРІРµСЂРѕРј

---

## рџ”§ РЁР°Рі 1: Р”РёР°РіРЅРѕСЃС‚РёРєР° РЅР° СЃРµСЂРІРµСЂРµ

РџРѕРґРєР»СЋС‡РёС‚РµСЃСЊ Рє СЃРµСЂРІРµСЂСѓ:
```bash
ssh root@45.147.248.134
# РџР°СЂРѕР»СЊ: 8VkuQOl6e63lkWF
```

Р—Р°РіСЂСѓР·РёС‚Рµ С„Р°Р№Р»С‹ РЅР° СЃРµСЂРІРµСЂ:
```bash
cd /root/cryp_land/telegram-bot

# РЎРєР°С‡Р°С‚СЊ РЅРѕРІС‹Рµ С„Р°Р№Р»С‹ СЃ СЂРµРїРѕР·РёС‚РѕСЂРёСЏ
git pull

# Р•СЃР»Рё С„Р°Р№Р»С‹ РЅРµ РїРѕСЏРІРёР»РёСЃСЊ, СЃРѕР·РґР°Р№С‚Рµ РІСЂСѓС‡РЅСѓСЋ РёР»Рё СЃРєРѕРїРёСЂСѓР№С‚Рµ С‡РµСЂРµР· scp
```

Р—Р°РїСѓСЃС‚РёС‚Рµ РґРёР°РіРЅРѕСЃС‚РёРєСѓ:
```bash
chmod +x diagnose-paypal.sh
./diagnose-paypal.sh
```

Р­С‚Р° РєРѕРјР°РЅРґР° РїРѕРєР°Р¶РµС‚:
- вњ… РџРѕР»СѓС‡Р°РµС‚ Р»Рё СЃРµСЂРІРµСЂ webhooks РѕС‚ PayPal
- вњ… РљР°РєРёРµ РґРµРїРѕР·РёС‚С‹ РµСЃС‚СЊ РІ Р±Р°Р·Рµ Рё РёС… СЃС‚Р°С‚СѓСЃ
- вњ… РќР°СЃС‚СЂРѕР№РєРё PayPal
- вњ… Р Р°Р±РѕС‚Р°РµС‚ Р»Рё webhook endpoint

---

## рџ”§ РЁР°Рі 2: РџСЂРѕРІРµСЂРєР° РєРѕРЅРєСЂРµС‚РЅРѕРіРѕ РґРµРїРѕР·РёС‚Р°

РџСЂРѕРІРµСЂСЊС‚Рµ РїРѕСЃР»РµРґРЅРёРµ РґРµРїРѕР·РёС‚С‹ PayPal:
```bash
node check-paypal-issue.cjs
```

РќР°Р№РґРёС‚Рµ РІР°С€ РґРµРїРѕР·РёС‚ Рё РїРѕСЃРјРѕС‚СЂРёС‚Рµ:
- **Status**: РґРѕР»Р¶РµРЅ Р±С‹С‚СЊ COMPLETED (РµСЃР»Рё PENDING - РїР»Р°С‚РµР¶ РЅРµ РѕР±СЂР°Р±РѕС‚Р°РЅ)
- **PayPal Order ID**: ID Р·Р°РєР°Р·Р° РѕС‚ PayPal (РЅР°РїСЂРёРјРµСЂ, `7AB12345CD678901E`)
- **User Total Deposit**: С‚РµРєСѓС‰РёР№ Р±Р°Р»Р°РЅСЃ РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ

---

## рџ”§ РЁР°Рі 3: Р СѓС‡РЅРѕР№ Р·Р°С…РІР°С‚ РїР»Р°С‚РµР¶Р° (РµСЃР»Рё webhook РЅРµ СЃСЂР°Р±РѕС‚Р°Р»)

Р•СЃР»Рё РґРµРїРѕР·РёС‚ РІ СЃС‚Р°С‚СѓСЃРµ PENDING, РёСЃРїРѕР»СЊР·СѓР№С‚Рµ Order ID РґР»СЏ СЂСѓС‡РЅРѕРіРѕ Р·Р°С…РІР°С‚Р°:

```bash
node manual-paypal-capture.cjs <ORDER_ID>
```

РќР°РїСЂРёРјРµСЂ:
```bash
node manual-paypal-capture.cjs 7AB12345CD678901E
```

Р­С‚РѕС‚ СЃРєСЂРёРїС‚:
1. вњ… РќР°Р№РґРµС‚ РґРµРїРѕР·РёС‚ РІ Р±Р°Р·Рµ
2. вњ… Р—Р°С…РІР°С‚РёС‚ РїР»Р°С‚РµР¶ РёР· PayPal
3. вњ… РћР±РЅРѕРІРёС‚ Р±Р°Р»Р°РЅСЃ РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ
4. вњ… РџСЂРёС€Р»РµС‚ СѓРІРµРґРѕРјР»РµРЅРёРµ РІ Р±РѕС‚

---

## рџ”§ РЁР°Рі 4: РџСЂРѕРІРµСЂРєР° PayPal Webhook РЅР°СЃС‚СЂРѕРµРє

### 4.1. РџСЂРѕРІРµСЂСЊС‚Рµ, РЅР°СЃС‚СЂРѕРµРЅ Р»Рё webhook РІ PayPal

1. Р—Р°Р№РґРёС‚Рµ РІ PayPal Developer Dashboard: https://developer.paypal.com/dashboard/
2. Р’С‹Р±РµСЂРёС‚Рµ РІР°С€Рµ РїСЂРёР»РѕР¶РµРЅРёРµ (С‚Рѕ, РѕС‚ РєРѕС‚РѕСЂРѕРіРѕ CLIENT_ID)
3. РџРµСЂРµР№РґРёС‚Рµ РІ **Webhooks**
4. РџСЂРѕРІРµСЂСЊС‚Рµ, РµСЃС‚СЊ Р»Рё webhook СЃ URL: `https://api.syntrix.uno/api/paypal-webhook`

### 4.2. Р•СЃР»Рё webhook РЅРµ РЅР°СЃС‚СЂРѕРµРЅ:

РЎРѕР·РґР°Р№С‚Рµ webhook:
1. РќР°Р¶РјРёС‚Рµ **"Add Webhook"**
2. **Webhook URL**: `https://api.syntrix.uno/api/paypal-webhook`
3. **Event types**: РІС‹Р±РµСЂРёС‚Рµ:
   - вњ… `CHECKOUT.ORDER.APPROVED`
   - вњ… `PAYMENT.CAPTURE.COMPLETED`
4. РЎРѕС…СЂР°РЅРёС‚Рµ

### 4.3. РџСЂРѕС‚РµСЃС‚РёСЂСѓР№С‚Рµ webhook:

Р’ PayPal Dashboard:
1. Р’С‹Р±РµСЂРёС‚Рµ РІР°С€ webhook
2. РќР°Р¶РјРёС‚Рµ **"Simulate Events"**
3. Р’С‹Р±РµСЂРёС‚Рµ `CHECKOUT.ORDER.APPROVED`
4. РќР°Р¶РјРёС‚Рµ **"Send"**

РџСЂРѕРІРµСЂСЊС‚Рµ Р»РѕРіРё РЅР° СЃРµСЂРІРµСЂРµ:
```bash
pm2 logs syntrix --lines 20
```

Р’С‹ РґРѕР»Р¶РЅС‹ СѓРІРёРґРµС‚СЊ:
```
рџ“Ё PayPal Webhook received
Webhook event type: CHECKOUT.ORDER.APPROVED
```

---

## рџ”§ РЁР°Рі 5: РџСЂРѕРІРµСЂРєР° Р»РѕРіРѕРІ СЃРµСЂРІРµСЂР°

РџРѕСЃРјРѕС‚СЂРёС‚Рµ Р»РѕРіРё Р·Р° РїРѕСЃР»РµРґРЅРёР№ С‡Р°СЃ:
```bash
pm2 logs syntrix --lines 200 | grep -i "paypal\|webhook\|deposit"
```

РС‰РёС‚Рµ:
- вњ… `PayPal Webhook received` - webhook РїРѕР»СѓС‡РµРЅ
- вќЊ `No pending deposit found` - РґРµРїРѕР·РёС‚ РЅРµ РЅР°Р№РґРµРЅ РІ Р±Р°Р·Рµ
- вќЊ `Failed to auto-capture payment` - РѕС€РёР±РєР° РїСЂРё Р·Р°С…РІР°С‚Рµ
- вњ… `Deposit completed automatically` - СѓСЃРїРµС€РЅРѕ РѕР±СЂР°Р±РѕС‚Р°РЅРѕ

---

## рџ”§ РЁР°Рі 6: РџСЂРѕРІРµСЂРєР° РєРѕРЅРєСЂРµС‚РЅРѕРіРѕ РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ

Р•СЃР»Рё Р·РЅР°РµС‚Рµ Telegram ID РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ:
```bash
node check-user.cjs
```

(РћС‚СЂРµРґР°РєС‚РёСЂСѓР№С‚Рµ С„Р°Р№Р» Рё СѓРєР°Р¶РёС‚Рµ РЅСѓР¶РЅС‹Р№ telegramId)

---

## рџ“‹ Р§Р°СЃС‚С‹Рµ РїСЂРѕР±Р»РµРјС‹ Рё СЂРµС€РµРЅРёСЏ

### РџСЂРѕР±Р»РµРјР° 1: Webhook РЅРµ РїСЂРёС…РѕРґРёС‚ РѕС‚ PayPal
**РџСЂРёС‡РёРЅР°**: Webhook РЅРµ РЅР°СЃС‚СЂРѕРµРЅ РёР»Рё РЅРµРїСЂР°РІРёР»СЊРЅС‹Р№ URL

**Р РµС€РµРЅРёРµ**:
1. РќР°СЃС‚СЂРѕР№С‚Рµ webhook РІ PayPal Dashboard (СЃРј. РЁР°Рі 4)
2. РЈР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ URL РїСЂР°РІРёР»СЊРЅС‹Р№: `https://api.syntrix.uno/api/paypal-webhook`
3. РџСЂРѕС‚РµСЃС‚РёСЂСѓР№С‚Рµ webhook С‡РµСЂРµР· PayPal Dashboard

### РџСЂРѕР±Р»РµРјР° 2: Webhook РїСЂРёС…РѕРґРёС‚, РЅРѕ РґРµРїРѕР·РёС‚ РЅРµ РЅР°Р№РґРµРЅ
**РџСЂРёС‡РёРЅР°**: Order ID РЅРµ СЃРѕРІРїР°РґР°РµС‚ РёР»Рё РґРµРїРѕР·РёС‚ РЅРµ СЃРѕР·РґР°РЅ РІ Р±Р°Р·Рµ

**Р РµС€РµРЅРёРµ**:
1. РџСЂРѕРІРµСЂСЊС‚Рµ Р»РѕРіРё: `pm2 logs syntrix | grep "No pending deposit found"`
2. РџСЂРѕРІРµСЂСЊС‚Рµ Р±Р°Р·Сѓ: `node check-paypal-issue.cjs`
3. Р•СЃР»Рё РґРµРїРѕР·РёС‚Р° РЅРµС‚ - РїСЂРѕР±Р»РµРјР° РїСЂРё СЃРѕР·РґР°РЅРёРё Р·Р°РєР°Р·Р°

### РџСЂРѕР±Р»РµРјР° 3: Р”РµРїРѕР·РёС‚ СЃРѕР·РґР°РЅ, РЅРѕ webhook РЅРµ РѕР±СЂР°Р±РѕС‚Р°Р» РµРіРѕ
**РџСЂРёС‡РёРЅР°**: РћС€РёР±РєР° РїСЂРё РѕР±СЂР°Р±РѕС‚РєРµ webhook

**Р РµС€РµРЅРёРµ**:
1. РќР°Р№РґРёС‚Рµ Order ID РІ Р»РѕРіР°С… РёР»Рё Р±Р°Р·Рµ
2. РСЃРїРѕР»СЊР·СѓР№С‚Рµ СЂСѓС‡РЅРѕР№ Р·Р°С…РІР°С‚: `node manual-paypal-capture.cjs <ORDER_ID>`

### РџСЂРѕР±Р»РµРјР° 4: РџР»Р°С‚РµР¶ РЅРµ РјРѕР¶РµС‚ Р±С‹С‚СЊ Р·Р°С…РІР°С‡РµРЅ
**РџСЂРёС‡РёРЅР°**: РџР»Р°С‚РµР¶ РёСЃС‚РµРє РёР»Рё РѕС‚РјРµРЅРµРЅ РІ PayPal

**Р РµС€РµРЅРёРµ**:
1. РџСЂРѕРІРµСЂСЊС‚Рµ СЃС‚Р°С‚СѓСЃ РІ PayPal Dashboard в†’ Orders
2. Р•СЃР»Рё РїР»Р°С‚РµР¶ РѕС‚РјРµРЅРµРЅ - СЃРѕР·РґР°Р№С‚Рµ РІРѕР·РІСЂР°С‚ РїРѕР»СЊР·РѕРІР°С‚РµР»СЋ
3. Р•СЃР»Рё РїР»Р°С‚РµР¶ Р·Р°РІРµСЂС€РµРЅ РІ PayPal, РЅРѕ РЅРµ РІ Р±Р°Р·Рµ - РёСЃРїРѕР»СЊР·СѓР№С‚Рµ СЂСѓС‡РЅРѕР№ Р·Р°С…РІР°С‚

---

## рџљЂ Р‘С‹СЃС‚СЂРѕРµ СЂРµС€РµРЅРёРµ (РµСЃР»Рё webhook РЅРµ СЂР°Р±РѕС‚Р°РµС‚)

Р•СЃР»Рё webhook РЅРµ РЅР°СЃС‚СЂРѕРµРЅ РёР»Рё РЅРµ СЂР°Р±РѕС‚Р°РµС‚:

```bash
# 1. РќР°Р№РґРёС‚Рµ РІСЃРµ PENDING PayPal РґРµРїРѕР·РёС‚С‹
node check-paypal-issue.cjs

# 2. Р”Р»СЏ РєР°Р¶РґРѕРіРѕ PENDING РґРµРїРѕР·РёС‚Р° РІС‹РїРѕР»РЅРёС‚Рµ:
node manual-paypal-capture.cjs <ORDER_ID>

# 3. РќР°СЃС‚СЂРѕР№С‚Рµ webhook РґР»СЏ Р±СѓРґСѓС‰РёС… РїР»Р°С‚РµР¶РµР№ (СЃРј. РЁР°Рі 4)
```

---

## рџ“ћ Р•СЃР»Рё РЅРёС‡РµРіРѕ РЅРµ РїРѕРјРѕРіР»Рѕ

1. РЎРѕР±РµСЂРёС‚Рµ РёРЅС„РѕСЂРјР°С†РёСЋ:
   - Output РѕС‚ `diagnose-paypal.sh`
   - Output РѕС‚ `check-paypal-issue.cjs`
   - Order ID РѕС‚ PayPal
   - Telegram ID РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ

2. РџСЂРѕРІРµСЂСЊС‚Рµ PayPal Dashboard:
   - Р•СЃС‚СЊ Р»Рё С‚Р°Рј РїР»Р°С‚РµР¶?
   - РљР°РєРѕР№ РµРіРѕ СЃС‚Р°С‚СѓСЃ?
   - РљРѕРіРґР° РѕРЅ Р±С‹Р» СЃРѕР·РґР°РЅ?

3. РџСЂРѕРІРµСЂСЊС‚Рµ, СЂР°Р±РѕС‚Р°РµС‚ Р»Рё API:
   ```bash
   curl https://api.syntrix.uno/api/paypal-webhook
   ```

---

## вњ… РџРѕСЃР»Рµ РёСЃРїСЂР°РІР»РµРЅРёСЏ

1. РџРµСЂРµР·Р°РїСѓСЃС‚РёС‚Рµ Р±РѕС‚:
   ```bash
   pm2 restart syntrix
   ```

2. РџСЂРѕС‚РµСЃС‚РёСЂСѓР№С‚Рµ РЅРѕРІС‹Р№ РїР»Р°С‚РµР¶:
   - РЎРѕР·РґР°Р№С‚Рµ С‚РµСЃС‚РѕРІС‹Р№ РґРµРїРѕР·РёС‚
   - РџСЂРѕРІРµСЂСЊС‚Рµ Р»РѕРіРё
   - РЈР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ webhook РїРѕР»СѓС‡РµРЅ

3. РЈРІРµРґРѕРјРёС‚Рµ РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ Рѕ Р·Р°С‡РёСЃР»РµРЅРёРё СЃСЂРµРґСЃС‚РІ (РµСЃР»Рё РёСЃРїРѕР»СЊР·РѕРІР°Р»Рё СЂСѓС‡РЅРѕР№ Р·Р°С…РІР°С‚)


