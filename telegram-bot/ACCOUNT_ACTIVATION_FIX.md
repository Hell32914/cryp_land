# Исправление системы активации аккаунтов через Contact Support

## Проблема
Ранее при получении бонусного токена через Contact Support:
- Токен начислялся при нажатии кнопки SEND
- Но аккаунт **НЕ активировался** автоматически
- Если пользователь закрывал окно после SEND, он получал токен, но оставался неактивным

## Что исправлено

### 1. Автоматическая активация при получении токена
**Файл**: `telegram-bot/src/api.ts`

Функция `claimContactSupportBonus` теперь автоматически активирует аккаунт при начислении бонусного токена:

```typescript
// Activate account if it's INACTIVE (bonus token activates the account)
if (user.status === 'INACTIVE') {
  updateData.status = 'ACTIVE'
}
```

### 2. Скрипт массовой активации
**Файл**: `telegram-bot/activate-accounts-with-token.cjs`

Создан скрипт для активации всех существующих аккаунтов, у которых есть бонусный токен, но статус INACTIVE.

**Использование**:
```bash
cd telegram-bot
node activate-accounts-with-token.cjs
```

**Что делает**:
- Находит все INACTIVE аккаунты с bonusTokens > 0
- Показывает список найденных пользователей
- Дает 5 секунд на отмену (Ctrl+C)
- Активирует все найденные аккаунты
- Показывает финальную статистику

### 3. Команда в админ панели бота
**Файл**: `telegram-bot/src/index.ts`

Добавлена новая кнопка в админ меню: **"✅ Activate Accounts with Tokens"**

**Как использовать**:
1. Открыть бота и нажать `/admin`
2. Нажать кнопку **"✅ Activate Accounts with Tokens"**
3. Бот покажет список аккаунтов для активации
4. Подтвердить активацию кнопкой **"✅ Yes, Activate All"**

**Что делает**:
- Находит все INACTIVE аккаунты с токенами
- Показывает первые 5 пользователей (для предпросмотра)
- Запрашивает подтверждение
- Активирует все аккаунты одной командой

## Логика работы

### Правильный флоу (после исправления):
1. Пользователь видит модальное окно Contact Support
2. Если закрывает окно → ничего не происходит ✅
3. Если нажимает SEND:
   - API вызывает `claimContactSupportBonus`
   - Начисляется бонусный токен
   - **Аккаунт автоматически активируется** (если был INACTIVE)
   - Открывается чат с поддержкой
4. Даже если пользователь закроет окно после SEND, аккаунт уже активен ✅

### Что НЕ изменилось:
- Токен начисляется только при нажатии SEND (не при открытии окна)
- Таймер работает как раньше (по умолчанию 48 часов с момента регистрации)
- Пользователь может получить токен только один раз

## Технические детали

### Изменения в `api.ts`:
```typescript
// До:
return prisma.user.update({
  where: { telegramId },
  data: {
    contactSupportSeen: true,
    bonusTokens: { increment: bonusAmount },
    // ... другие поля
  },
})

// После:
const updateData: any = {
  contactSupportSeen: true,
  bonusTokens: { increment: bonusAmount },
  // ... другие поля
}

// Активация аккаунта если INACTIVE
if (user.status === 'INACTIVE') {
  updateData.status = 'ACTIVE'
}

return prisma.user.update({
  where: { telegramId },
  data: updateData,
})
```

### Новые callback handlers в `index.ts`:
- `admin_activate_token_accounts` - показывает список аккаунтов
- `confirm_activate_token_accounts` - выполняет активацию

## Тестирование

### Проверить исправление:
1. Создать тестового пользователя со статусом INACTIVE
2. Начислить ему токен через Contact Support или вручную
3. Проверить, что статус изменился на ACTIVE

### SQL запрос для проверки:
```sql
-- Найти INACTIVE аккаунты с токенами
SELECT 
  id, 
  telegramId, 
  username, 
  bonusTokens, 
  status, 
  contactSupportSeen
FROM User
WHERE status = 'INACTIVE' AND bonusTokens > 0;
```

## Рекомендации

1. **После деплоя**: Запустить скрипт `activate-accounts-with-token.cjs` для активации существующих аккаунтов
2. **Мониторинг**: Периодически проверять, нет ли INACTIVE аккаунтов с токенами
3. **Логирование**: Следить за логами активации в консоли бота

## Безопасность

- Скрипт требует подтверждения (5 секунд ожидания)
- Команда в боте доступна только администраторам
- Все изменения логируются
- Можно отменить операцию до выполнения
