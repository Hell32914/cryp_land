# üîí –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –£–Ø–ó–í–ò–ú–û–°–¢–ò

### #1 - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Webhook Secret Token
**–£—è–∑–≤–∏–º–æ—Å—Ç—å:** –õ—é–±–æ–π –º–æ–≥ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–¥–¥–µ–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ `/webhook` endpoint –±–æ—Ç–∞.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è `WEBHOOK_SECRET_TOKEN` –≤ `api.ts`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –≤ middleware –¥–ª—è `/webhook`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `bot.api.setWebhook()` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `secret_token`

**–§–∞–π–ª—ã:**
- `telegram-bot/src/api.ts` (lines 12-18, 2243-2252)
- `telegram-bot/src/index.ts` (lines 3835-3842)

---

### #2 - BOT_TOKEN —Ä–∞—Å–∫—Ä—ã—Ç
**–£—è–∑–≤–∏–º–æ—Å—Ç—å:** –¢–æ–∫–µ–Ω –±–æ—Ç–∞ `8450436953:AAEwpSor3yHkPR5uTZEibGcwQbKTeqXKRSg` –±—ã–ª —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω –≤ —á–∞—Ç–µ.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–ª –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ @BotFather
- ‚ö†Ô∏è **–í–ê–ñ–ù–û:** `.env` –∑–∞—â–∏—â—ë–Ω `.gitignore`, –Ω–æ –ù–ï —à–∏—Ñ—Ä—É–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (process.env)
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ `.env` –≤ git
- –†–µ–≥—É–ª—è—Ä–Ω–æ —Ä–æ—Ç–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω—ã

---

### #3 - –ü–æ–¥–º–µ–Ω–∞ telegramId –≤ API –∑–∞–ø—Ä–æ—Å–∞—Ö
**–£—è–∑–≤–∏–º–æ—Å—Ç—å:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ endpoint'—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª–∏, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –æ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∞–∫–∫–∞—É–Ω—Ç–∞.

**–ü—Ä–∏–º–µ—Ä –∞—Ç–∞–∫–∏:**
```bash
# –õ—é–±–æ–π –º–æ–≥ –≤—ã–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏ —Å –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
curl -X POST https://api.syntrix.website/api/user/503856039/create-withdrawal \
  -H "Content-Type: application/json" \
  -d '{"amount": 10, "address": "0x8B2f1908cD900128490868750507991811E46341", ...}'
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (`USER_JWT_SECRET`)
- ‚úÖ –°–æ–∑–¥–∞–Ω endpoint `/api/user/auth` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω middleware `requireUserAuth` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞
- ‚úÖ –ó–∞—â–∏—â–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ endpoint'—ã:
  - `GET /api/user/:telegramId` - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `GET /api/user/:telegramId/notifications` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  - `POST /api/user/:telegramId/reinvest` - —Ä–µ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  - **`POST /api/user/:telegramId/create-withdrawal`** - –í–´–í–û–î –î–ï–ù–ï–ì (–∫—Ä–∏—Ç–∏—á–Ω–æ!)

**–§–∞–π–ª—ã:**
- `telegram-bot/src/api.ts` (lines 75-81, 137-159, 1011, 1088, 1120, 1362)
- `telegram-app/src/App.tsx` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
- `telegram-app/src/hooks/useUserData.ts` - –æ–±–Ω–æ–≤–ª—ë–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è authToken

---

## üìã –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –î–ï–ü–õ–û–Æ

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å .env —Ñ–∞–π–ª

–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –¥–æ–±–∞–≤—å—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã:

```bash
ssh root@syntrix

cd ~/cryp_land/telegram-bot

# –î–æ–±–∞–≤—å—Ç–µ –≤ .env —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏:
nano .env
```

–î–æ–±–∞–≤—å—Ç–µ:
```env
# Webhook security
WEBHOOK_SECRET_TOKEN=<—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ>

# User JWT secret for mini-app authentication
USER_JWT_SECRET=<—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ>
```

**–ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞:**
1. –ë–æ—Ç –≤—ã–≤–µ–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –≤ –∫–æ–Ω—Å–æ–ª—å
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏—Ö –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ `.env`
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞

### –®–∞–≥ 2: –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å –±–æ—Ç–∞

```bash
cd ~/cryp_land/telegram-bot

# –°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
npm run build

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
pm2 restart syntrix

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
pm2 logs syntrix --lines 50
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
‚úÖ Webhook handler registered at /webhook with secret token validation
üîó Setting webhook to: https://api.syntrix.website/webhook
‚úÖ Webhook set successfully with secret token
```

### –®–∞–≥ 3: –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å mini-app

```bash
cd ~/cryp_land/telegram-app

# –°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
npm run build

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
pm2 restart telegram-app

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
pm2 logs telegram-app --lines 20
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

#### –¢–µ—Å—Ç 1: Webhook –∑–∞—â–∏—â—ë–Ω
```bash
# –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –±–µ–∑ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ (–¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å 401)
curl -X POST https://api.syntrix.website/webhook \
  -H "Content-Type: application/json" \
  -d '{"update_id": 1, "message": {"text": "test"}}'
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** `401 Unauthorized`

#### –¢–µ—Å—Ç 2: API –∑–∞—â–∏—â—ë–Ω –æ—Ç –ø–æ–¥–º–µ–Ω—ã
```bash
# –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ (–¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å 401)
curl https://api.syntrix.website/api/user/503856039
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** `{"error":"Authentication required"}`

#### –¢–µ—Å—Ç 3: –í—ã–≤–æ–¥ –¥–µ–Ω–µ–≥ –∑–∞—â–∏—â—ë–Ω
```bash
# –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ (–¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å 401)
curl -X POST https://api.syntrix.website/api/user/503856039/create-withdrawal \
  -H "Content-Type: application/json" \
  -d '{"amount": 10, "address": "0x123", "currency": "USDT", "network": "TRX"}'
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** `{"error":"Authentication required"}`

### –®–∞–≥ 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ mini-app

1. –û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–∞–ø–ø –≤ Telegram
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (Telegram Desktop ‚Üí Dev Tools)
3. –û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:
   ```
   ‚úÖ User authenticated successfully
   ```
4. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:
   - –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å (–¥–æ–ª–∂–Ω—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –¥–∞–Ω–Ω—ã–µ)
   - –°–æ–∑–¥–∞—Ç—å –¥–µ–ø–æ–∑–∏—Ç
   - –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å –±–∞–ª–∞–Ω—Å)

---

## üîç –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### TODO –¥–ª—è production:

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è Telegram WebApp initData**
   ```typescript
   // –í /api/user/auth –¥–æ–±–∞–≤–∏—Ç—å:
   import crypto from 'crypto'
   
   function validateTelegramWebAppData(initData: string, botToken: string): boolean {
     // https://core.telegram.org/bots/webapps#validating-data-received-via-the-mini-app
     const urlParams = new URLSearchParams(initData)
     const hash = urlParams.get('hash')
     urlParams.delete('hash')
     
     const dataCheckString = Array.from(urlParams.entries())
       .sort(([a], [b]) => a.localeCompare(b))
       .map(([key, value]) => `${key}=${value}`)
       .join('\n')
     
     const secretKey = crypto.createHmac('sha256', 'WebAppData').update(botToken).digest()
     const calculatedHash = crypto.createHmac('sha256', secretKey).update(dataCheckString).digest('hex')
     
     return calculatedHash === hash
   }
   ```

2. **IP logging –¥–ª—è –≤—Å–µ—Ö –≤—ã–≤–æ–¥–æ–≤**
   - –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ `create-withdrawal` endpoint
   - –î–æ–±–∞–≤–∏—Ç—å –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ IP –ø—Ä–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –≤—ã–≤–æ–¥–∞—Ö

3. **Rate limiting**
   ```bash
   npm install express-rate-limit
   ```

4. **2FA –¥–ª—è –≤—ã–≤–æ–¥–æ–≤**
   - Email confirmation
   - SMS verification
   - Telegram bot confirmation message

5. **Webhook IP whitelist**
   - –†–∞–∑—Ä–µ—à–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Ç–æ–ª—å–∫–æ —Å IP –∞–¥—Ä–µ—Å–æ–≤ Telegram: https://core.telegram.org/bots/webhooks#the-short-version

---

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï

**–í–∞—à –∏–Ω—Ü–∏–¥–µ–Ω—Ç —Å –≤—ã–≤–æ–¥–æ–º $10 —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –ø—Ä–æ–∏–∑–æ—à—ë–ª –∏–º–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ —É—è–∑–≤–∏–º–æ—Å—Ç—å #3.**

–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è **–õ–Æ–ë–û–ô** –º–æ–≥:
1. –£–∑–Ω–∞—Ç—å –≤–∞—à Telegram ID (503856039) –∏–∑ –ø—É–±–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å POST –∑–∞–ø—Ä–æ—Å –Ω–∞ `/api/user/503856039/create-withdrawal`
3. –í—ã–≤–µ—Å—Ç–∏ –≤–∞—à–∏ –¥–µ–Ω—å–≥–∏ –Ω–∞ —Å–≤–æ–π –∫–æ—à–µ–ª—ë–∫

**–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –¥–µ–ø–ª–æ—è** —Ç–∞–∫–∏–µ –∞—Ç–∞–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã - —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–π JWT —Ç–æ–∫–µ–Ω, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –∞–∫–∫–∞—É–Ω—Ç–∞.

---

## üìû –ü–û–î–î–ï–†–ñ–ö–ê

–ï—Å–ª–∏ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `pm2 logs syntrix`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `.env` —Ñ–∞–π–ª
3. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—Å–µ —Ç–æ–∫–µ–Ω—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞: `pm2 restart all`
