# рџ”’ РСЃРїСЂР°РІР»РµРЅРёРµ СѓСЏР·РІРёРјРѕСЃС‚РµР№ Р±РµР·РѕРїР°СЃРЅРѕСЃС‚Рё

## вњ… РРЎРџР РђР’Р›Р•РќРќР«Р• РЈРЇР—Р’РРњРћРЎРўР

### #1 - РћС‚СЃСѓС‚СЃС‚РІРёРµ Webhook Secret Token
**РЈСЏР·РІРёРјРѕСЃС‚СЊ:** Р›СЋР±РѕР№ РјРѕРі РѕС‚РїСЂР°РІР»СЏС‚СЊ РїРѕРґРґРµР»СЊРЅС‹Рµ РѕР±РЅРѕРІР»РµРЅРёСЏ РЅР° `/webhook` endpoint Р±РѕС‚Р°.

**РСЃРїСЂР°РІР»РµРЅРёРµ:**
- вњ… Р”РѕР±Р°РІР»РµРЅР° РіРµРЅРµСЂР°С†РёСЏ `WEBHOOK_SECRET_TOKEN` РІ `api.ts`
- вњ… Р”РѕР±Р°РІР»РµРЅР° РїСЂРѕРІРµСЂРєР° С‚РѕРєРµРЅР° РІ middleware РґР»СЏ `/webhook`
- вњ… РћР±РЅРѕРІР»РµРЅ `bot.api.setWebhook()` СЃ РїР°СЂР°РјРµС‚СЂРѕРј `secret_token`

**Р¤Р°Р№Р»С‹:**
- `telegram-bot/src/api.ts` (lines 12-18, 2243-2252)
- `telegram-bot/src/index.ts` (lines 3835-3842)

---

### #2 - BOT_TOKEN СЂР°СЃРєСЂС‹С‚
**РЈСЏР·РІРёРјРѕСЃС‚СЊ:** РўРѕРєРµРЅ Р±РѕС‚Р° `8450436953:AAEwpSor3yHkPR5uTZEibGcwQbKTeqXKRSg` Р±С‹Р» СЃРєРѕРјРїСЂРѕРјРµС‚РёСЂРѕРІР°РЅ РІ С‡Р°С‚Рµ.

**РСЃРїСЂР°РІР»РµРЅРёРµ:**
- вњ… РџРѕР»СЊР·РѕРІР°С‚РµР»СЊ СЃРѕР·РґР°Р» РЅРѕРІС‹Р№ С‚РѕРєРµРЅ С‡РµСЂРµР· @BotFather
- вљ пёЏ **Р’РђР–РќРћ:** `.env` Р·Р°С‰РёС‰С‘РЅ `.gitignore`, РЅРѕ РќР• С€РёС„СЂСѓРµС‚СЃСЏ РЅР° СЃРµСЂРІРµСЂРµ

**Р РµРєРѕРјРµРЅРґР°С†РёРё:**
- РСЃРїРѕР»СЊР·СѓР№С‚Рµ РїРµСЂРµРјРµРЅРЅС‹Рµ РѕРєСЂСѓР¶РµРЅРёСЏ РЅР° СЃРµСЂРІРµСЂРµ (process.env)
- РќРёРєРѕРіРґР° РЅРµ РєРѕРјРјРёС‚СЊС‚Рµ `.env` РІ git
- Р РµРіСѓР»СЏСЂРЅРѕ СЂРѕС‚РёСЂСѓР№С‚Рµ С‚РѕРєРµРЅС‹

---

### #3 - РџРѕРґРјРµРЅР° telegramId РІ API Р·Р°РїСЂРѕСЃР°С…
**РЈСЏР·РІРёРјРѕСЃС‚СЊ:** РљСЂРёС‚РёС‡РµСЃРєРёРµ endpoint'С‹ РЅРµ РїСЂРѕРІРµСЂСЏР»Рё, С‡С‚Рѕ Р·Р°РїСЂРѕСЃ РѕС‚ СЂРµР°Р»СЊРЅРѕРіРѕ РІР»Р°РґРµР»СЊС†Р° Р°РєРєР°СѓРЅС‚Р°.

**РџСЂРёРјРµСЂ Р°С‚Р°РєРё:**
```bash
# Р›СЋР±РѕР№ РјРѕРі РІС‹РІРµСЃС‚Рё РґРµРЅСЊРіРё СЃ РІР°С€РµРіРѕ Р°РєРєР°СѓРЅС‚Р°
curl -X POST https://api.syntrix.uno/api/user/503856039/create-withdrawal \
  -H "Content-Type: application/json" \
  -d '{"amount": 10, "address": "0x8B2f1908cD900128490868750507991811E46341", ...}'
```

**РСЃРїСЂР°РІР»РµРЅРёРµ:**
- вњ… Р”РѕР±Р°РІР»РµРЅР° JWT Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёСЏ РґР»СЏ РїРѕР»СЊР·РѕРІР°С‚РµР»РµР№ (`USER_JWT_SECRET`)
- вњ… РЎРѕР·РґР°РЅ endpoint `/api/user/auth` РґР»СЏ РїРѕР»СѓС‡РµРЅРёСЏ С‚РѕРєРµРЅР°
- вњ… Р”РѕР±Р°РІР»РµРЅ middleware `requireUserAuth` РґР»СЏ РїСЂРѕРІРµСЂРєРё С‚РѕРєРµРЅР°
- вњ… Р—Р°С‰РёС‰РµРЅС‹ РєСЂРёС‚РёС‡РµСЃРєРёРµ endpoint'С‹:
  - `GET /api/user/:telegramId` - РїРѕР»СѓС‡РµРЅРёРµ РґР°РЅРЅС‹С… РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ
  - `GET /api/user/:telegramId/notifications` - СѓРІРµРґРѕРјР»РµРЅРёСЏ
  - `POST /api/user/:telegramId/reinvest` - СЂРµРёРЅРІРµСЃС‚РёСЂРѕРІР°РЅРёРµ
  - **`POST /api/user/:telegramId/create-withdrawal`** - Р’Р«Р’РћР” Р”Р•РќР•Р“ (РєСЂРёС‚РёС‡РЅРѕ!)

**Р¤Р°Р№Р»С‹:**
- `telegram-bot/src/api.ts` (lines 75-81, 137-159, 1011, 1088, 1120, 1362)
- `telegram-app/src/App.tsx` - РґРѕР±Р°РІР»РµРЅР° Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёСЏ Рё РёСЃРїРѕР»СЊР·РѕРІР°РЅРёРµ С‚РѕРєРµРЅР°
- `telegram-app/src/hooks/useUserData.ts` - РѕР±РЅРѕРІР»С‘РЅ РґР»СЏ РёСЃРїРѕР»СЊР·РѕРІР°РЅРёСЏ authToken

---

## рџ“‹ РРќРЎРўР РЈРљР¦РРЇ РџРћ Р”Р•РџР›РћР®

### РЁР°Рі 1: РћР±РЅРѕРІРёС‚СЊ .env С„Р°Р№Р»

РџРѕРґРєР»СЋС‡РёС‚РµСЃСЊ Рє СЃРµСЂРІРµСЂСѓ Рё РґРѕР±Р°РІСЊС‚Рµ СЃРµРєСЂРµС‚С‹:

```bash
ssh root@syntrix

cd ~/cryp_land/telegram-bot

# Р”РѕР±Р°РІСЊС‚Рµ РІ .env СЃР»РµРґСѓСЋС‰РёРµ СЃС‚СЂРѕРєРё:
nano .env
```

Р”РѕР±Р°РІСЊС‚Рµ:
```env
# Webhook security
WEBHOOK_SECRET_TOKEN=<СЃРіРµРЅРµСЂРёСЂСѓРµС‚СЃСЏ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё РїСЂРё РїРµСЂРІРѕРј Р·Р°РїСѓСЃРєРµ>

# User JWT secret for mini-app authentication
USER_JWT_SECRET=<СЃРіРµРЅРµСЂРёСЂСѓРµС‚СЃСЏ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё РїСЂРё РїРµСЂРІРѕРј Р·Р°РїСѓСЃРєРµ>
```

**РџРѕСЃР»Рµ РїРµСЂРІРѕРіРѕ Р·Р°РїСѓСЃРєР°:**
1. Р‘РѕС‚ РІС‹РІРµРґРµС‚ СЃРіРµРЅРµСЂРёСЂРѕРІР°РЅРЅС‹Рµ С‚РѕРєРµРЅС‹ РІ РєРѕРЅСЃРѕР»СЊ
2. РЎРєРѕРїРёСЂСѓР№С‚Рµ РёС… Рё РґРѕР±Р°РІСЊС‚Рµ РІ `.env`
3. РџРµСЂРµР·Р°РїСѓСЃС‚РёС‚Рµ Р±РѕС‚Р°

### РЁР°Рі 2: РЎРѕР±СЂР°С‚СЊ Рё Р·Р°РґРµРїР»РѕРёС‚СЊ Р±РѕС‚Р°

```bash
cd ~/cryp_land/telegram-bot

# РЎРѕР±СЂР°С‚СЊ РїСЂРѕРµРєС‚
npm run build

# РџРµСЂРµР·Р°РїСѓСЃС‚РёС‚СЊ Р±РѕС‚Р°
pm2 restart syntrix

# РџСЂРѕРІРµСЂРёС‚СЊ Р»РѕРіРё
pm2 logs syntrix --lines 50
```

**РћР¶РёРґР°РµРјС‹Р№ РІС‹РІРѕРґ:**
```
вњ… Webhook handler registered at /webhook with secret token validation
рџ”— Setting webhook to: https://api.syntrix.uno/webhook
вњ… Webhook set successfully with secret token
```

### РЁР°Рі 3: РЎРѕР±СЂР°С‚СЊ Рё Р·Р°РґРµРїР»РѕРёС‚СЊ mini-app

```bash
cd ~/cryp_land/telegram-app

# РЎРѕР±СЂР°С‚СЊ РїСЂРѕРµРєС‚
npm run build

# РџРµСЂРµР·Р°РїСѓСЃС‚РёС‚СЊ РїСЂРёР»РѕР¶РµРЅРёРµ
pm2 restart telegram-app

# РџСЂРѕРІРµСЂРёС‚СЊ Р»РѕРіРё
pm2 logs telegram-app --lines 20
```

### РЁР°Рі 4: РџСЂРѕРІРµСЂРєР° Р±РµР·РѕРїР°СЃРЅРѕСЃС‚Рё

#### РўРµСЃС‚ 1: Webhook Р·Р°С‰РёС‰С‘РЅ
```bash
# РџРѕРїС‹С‚РєР° РѕС‚РїСЂР°РІРёС‚СЊ Р·Р°РїСЂРѕСЃ Р±РµР· СЃРµРєСЂРµС‚РЅРѕРіРѕ С‚РѕРєРµРЅР° (РґРѕР»Р¶РЅР° РІРµСЂРЅСѓС‚СЊ 401)
curl -X POST https://api.syntrix.uno/webhook \
  -H "Content-Type: application/json" \
  -d '{"update_id": 1, "message": {"text": "test"}}'
```

**РћР¶РёРґР°РµРјС‹Р№ СЂРµР·СѓР»СЊС‚Р°С‚:** `401 Unauthorized`

#### РўРµСЃС‚ 2: API Р·Р°С‰РёС‰С‘РЅ РѕС‚ РїРѕРґРјРµРЅС‹
```bash
# РџРѕРїС‹С‚РєР° РїРѕР»СѓС‡РёС‚СЊ РґР°РЅРЅС‹Рµ Р±РµР· С‚РѕРєРµРЅР° (РґРѕР»Р¶РЅР° РІРµСЂРЅСѓС‚СЊ 401)
curl https://api.syntrix.uno/api/user/503856039
```

**РћР¶РёРґР°РµРјС‹Р№ СЂРµР·СѓР»СЊС‚Р°С‚:** `{"error":"Authentication required"}`

#### РўРµСЃС‚ 3: Р’С‹РІРѕРґ РґРµРЅРµРі Р·Р°С‰РёС‰С‘РЅ
```bash
# РџРѕРїС‹С‚РєР° РІС‹РІРµСЃС‚Рё РґРµРЅСЊРіРё Р±РµР· С‚РѕРєРµРЅР° (РґРѕР»Р¶РЅР° РІРµСЂРЅСѓС‚СЊ 401)
curl -X POST https://api.syntrix.uno/api/user/503856039/create-withdrawal \
  -H "Content-Type: application/json" \
  -d '{"amount": 10, "address": "0x123", "currency": "USDT", "network": "TRX"}'
```

**РћР¶РёРґР°РµРјС‹Р№ СЂРµР·СѓР»СЊС‚Р°С‚:** `{"error":"Authentication required"}`

### РЁР°Рі 5: РўРµСЃС‚РёСЂРѕРІР°РЅРёРµ РІ mini-app

1. РћС‚РєСЂРѕР№С‚Рµ РјРёРЅРё-Р°РїРї РІ Telegram
2. РџСЂРѕРІРµСЂСЊС‚Рµ РєРѕРЅСЃРѕР»СЊ Р±СЂР°СѓР·РµСЂР° (Telegram Desktop в†’ Dev Tools)
3. РћР¶РёРґР°РµРјС‹Рµ Р»РѕРіРё:
   ```
   вњ… User authenticated successfully
   ```
4. РџРѕРїСЂРѕР±СѓР№С‚Рµ:
   - РћС‚РєСЂС‹С‚СЊ РїСЂРѕС„РёР»СЊ (РґРѕР»Р¶РЅС‹ Р·Р°РіСЂСѓР·РёС‚СЊСЃСЏ РґР°РЅРЅС‹Рµ)
   - РЎРѕР·РґР°С‚СЊ РґРµРїРѕР·РёС‚
   - РџРѕРїСЂРѕР±РѕРІР°С‚СЊ РІС‹РІРѕРґ СЃСЂРµРґСЃС‚РІ (РµСЃР»Рё РµСЃС‚СЊ Р±Р°Р»Р°РЅСЃ)

---

## рџ”Ќ Р”РћРџРћР›РќРРўР•Р›Р¬РќР«Р• Р Р•РљРћРњР•РќР”РђР¦РР

### TODO РґР»СЏ production:

1. **Р’Р°Р»РёРґР°С†РёСЏ Telegram WebApp initData**
   ```typescript
   // Р’ /api/user/auth РґРѕР±Р°РІРёС‚СЊ:
   import crypto from 'crypto'
   
   function validateTelegramWebAppData(initData: string, botToken: string): boolean {
     // https://core.telegram.org/bots/webapps#validating-data-received-via-the-mini-app
     const urlParams = new URLSearchParams(initData)
     const hash = urlParams.get('hash')
     urlParams.delete('hash')
     
     const dataCheckString = Array.from(urlParams.entries())
       .sort(([a], [b]) => a.localeCompare(b))
       .map(([key, value]) => `${key}=${value}`)
       .join('\n')
     
     const secretKey = crypto.createHmac('sha256', 'WebAppData').update(botToken).digest()
     const calculatedHash = crypto.createHmac('sha256', secretKey).update(dataCheckString).digest('hex')
     
     return calculatedHash === hash
   }
   ```

2. **IP logging РґР»СЏ РІСЃРµС… РІС‹РІРѕРґРѕРІ**
   - РЈР¶Рµ СЂРµР°Р»РёР·РѕРІР°РЅРѕ РІ `create-withdrawal` endpoint
   - Р”РѕР±Р°РІРёС‚СЊ РІ Р°РґРјРёРЅ-РїР°РЅРµР»СЊ РѕС‚РѕР±СЂР°Р¶РµРЅРёРµ IP РїСЂРё РїРѕРґРѕР·СЂРёС‚РµР»СЊРЅС‹С… РІС‹РІРѕРґР°С…

3. **Rate limiting**
   ```bash
   npm install express-rate-limit
   ```

4. **2FA РґР»СЏ РІС‹РІРѕРґРѕРІ**
   - Email confirmation
   - SMS verification
   - Telegram bot confirmation message

5. **Webhook IP whitelist**
   - Р Р°Р·СЂРµС€РёС‚СЊ Р·Р°РїСЂРѕСЃС‹ С‚РѕР»СЊРєРѕ СЃ IP Р°РґСЂРµСЃРѕРІ Telegram: https://core.telegram.org/bots/webhooks#the-short-version

---

## вљ пёЏ РљР РРўРР§Р•РЎРљРћР• РџР Р•Р”РЈРџР Р•Р–Р”Р•РќРР•

**Р’Р°С€ РёРЅС†РёРґРµРЅС‚ СЃ РІС‹РІРѕРґРѕРј $10 СЃРєРѕСЂРµРµ РІСЃРµРіРѕ РїСЂРѕРёР·РѕС€С‘Р» РёРјРµРЅРЅРѕ С‡РµСЂРµР· СѓСЏР·РІРёРјРѕСЃС‚СЊ #3.**

Р”Рѕ РёСЃРїСЂР°РІР»РµРЅРёСЏ **Р›Р®Р‘РћР™** РјРѕРі:
1. РЈР·РЅР°С‚СЊ РІР°С€ Telegram ID (503856039) РёР· РїСѓР±Р»РёС‡РЅС‹С… РёСЃС‚РѕС‡РЅРёРєРѕРІ
2. РћС‚РїСЂР°РІРёС‚СЊ POST Р·Р°РїСЂРѕСЃ РЅР° `/api/user/503856039/create-withdrawal`
3. Р’С‹РІРµСЃС‚Рё РІР°С€Рё РґРµРЅСЊРіРё РЅР° СЃРІРѕР№ РєРѕС€РµР»С‘Рє

**РџРѕСЃР»Рµ СЌС‚РѕРіРѕ РґРµРїР»РѕСЏ** С‚Р°РєРёРµ Р°С‚Р°РєРё РЅРµРІРѕР·РјРѕР¶РЅС‹ - С‚СЂРµР±СѓРµС‚СЃСЏ РІР°Р»РёРґРЅС‹Р№ JWT С‚РѕРєРµРЅ, РєРѕС‚РѕСЂС‹Р№ РјРѕР¶РµС‚ РїРѕР»СѓС‡РёС‚СЊ С‚РѕР»СЊРєРѕ РІР»Р°РґРµР»РµС† Р°РєРєР°СѓРЅС‚Р°.

---

## рџ“ћ РџРћР”Р”Р•Р Р–РљРђ

Р•СЃР»Рё РїРѕСЃР»Рµ РґРµРїР»РѕСЏ С‡С‚Рѕ-С‚Рѕ РЅРµ СЂР°Р±РѕС‚Р°РµС‚:
1. РџСЂРѕРІРµСЂСЊС‚Рµ Р»РѕРіРё: `pm2 logs syntrix`
2. РџСЂРѕРІРµСЂСЊС‚Рµ `.env` С„Р°Р№Р»
3. РЈР±РµРґРёС‚РµСЃСЊ С‡С‚Рѕ РІСЃРµ С‚РѕРєРµРЅС‹ СЃРіРµРЅРµСЂРёСЂРѕРІР°РЅС‹
4. РџРµСЂРµР·Р°РїСѓСЃС‚РёС‚Рµ РѕР±Р° РїСЂРѕС†РµСЃСЃР°: `pm2 restart all`


