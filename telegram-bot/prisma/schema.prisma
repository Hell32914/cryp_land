// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                Int           @id @default(autoincrement())
  telegramId        String        @unique
  username          String?
  firstName         String?
  lastName          String?
  botStartedAt      DateTime?
  phoneNumber       String?
  languageCode      String?
  ipAddress         String?
  country           String?
  marketingSource   String?
  utmParams         String?
  status            String        @default("INACTIVE")
  balance           Float         @default(0)
  profit            Float         @default(0)
  totalDeposit      Float         @default(0)
  totalWithdraw     Float         @default(0)
  lifetimeDeposit   Float         @default(0)
  plan              String        @default("Bronze")
  kycRequired       Boolean       @default(false)
  isBlocked         Boolean       @default(false)
  isAdmin           Boolean       @default(false)
  isHidden          Boolean       @default(false)
  role              String        @default("user")
  comment           String?
  lastProfitUpdate  DateTime?
  referredBy        String?
  referralEarnings  Float         @default(0)
  isActiveReferral  Boolean       @default(false)
  bonusTokens       Float         @default(0)
  contactSupportSeen Boolean      @default(false)
  contactSupportBonusGrantedAt DateTime?
  contactSupportBonusExpiresAt DateTime?
  contactSupportBonusAmountGranted Float @default(0)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  deposits          Deposit[]
  withdrawals       Withdrawal[]
  notifications     Notification[]
  referrals         Referral[]    @relation("UserReferrals")
  dailyUpdates      DailyProfitUpdate[] @relation("UserDailyUpdates")
  aiAnalyticsRequestLogs AiAnalyticsRequestLog[]
}

model Referral {
  id              Int      @id @default(autoincrement())
  userId          Int
  user            User     @relation("UserReferrals", fields: [userId], references: [id])
  referredUserId  Int
  referredUsername String?
  level           Int
  earnings        Float    @default(0)
  createdAt       DateTime @default(now())
}

model DailyProfitUpdate {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation("UserDailyUpdates", fields: [userId], references: [id])
  amount      Float
  source      String   @default("DEPOSIT")
  timestamp   DateTime
  dailyTotal  Float
  notified    Boolean  @default(false)
  createdAt   DateTime @default(now())
}

model Deposit {
  id          Int            @id @default(autoincrement())
  userId      Int
  user        User           @relation(fields: [userId], references: [id])
  amount      Float
  status      String         @default("PENDING")
  paymentMethod String       @default("OXAPAY")
  currency    String         @default("USDT")
  network     String?
  txHash      String?
  trackId     String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model Withdrawal {
  id                Int            @id @default(autoincrement())
  userId            Int
  user              User           @relation(fields: [userId], references: [id])
  amount            Float
  status            String         @default("PENDING")
  paymentMethod     String         @default("OXAPAY")
  currency          String         @default("USDT")
  network           String?
  address           String
  paypalEmail       String?
  txHash            String?
  // Reservation breakdown (so rejected withdrawals can restore exact buckets)
  reservedProfit     Float         @default(0)
  reservedDeposit    Float         @default(0)
  ipAddress         String?
  userAgent         String?
  country           String?
  city              String?
  isp               String?
  timezone          String?
  language          String?
  referrer          String?
  deviceFingerprint String?
  screenResolution  String?
  isVpnProxy        Boolean?
  accountAge        Int?
  previousWithdrawals Int?
  depositToWithdrawRatio Float?
  hoursSinceLastDeposit Float?
  percentOfBalance  Float?
  ipChanged         Boolean?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  type      String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model TradingPost {
  id          Int      @id @default(autoincrement())
  orderNumber Int      @unique
  pair        String
  position    String
  profit      Float
  leverage    Int
  entryPrice  Float
  lastPrice   Float
  postedAt    DateTime @default(now())
}

model AiAnalyticsRequestLog {
  id               Int      @id @default(autoincrement())
  userId           Int
  user             User     @relation(fields: [userId], references: [id])
  kyivDate         String
  locale           String?
  symbol           String?
  timeframe        String?
  requestedModelId String?
  generatedAt      DateTime
  items            Json
  createdAt        DateTime @default(now())

  @@index([userId, kyivDate, createdAt])
}

model Expense {
  id        Int      @id @default(autoincrement())
  category  String
  comment   String
  amount    Float
  createdAt DateTime @default(now())
}

model MarketingLink {
  id             Int      @id @default(autoincrement())
  linkId         String   @unique
  source         String
  utmParams      String?
  clicks         Int      @default(0)
  conversions    Int      @default(0)
  revenue        Float    @default(0)
  isActive       Boolean  @default(true)
  trafficCost    Float    @default(0)
  trafficerName  String?
  stream         String?
  geo            String?
  creative       String?
  language       String?
  domain         String?
  trackingPixel  String?
  channelInviteLink String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model GlobalSettings {
  id                  Int       @id @default(autoincrement())
  contactSupportEnabled Boolean @default(false)
  contactSupportBonusAmount Float @default(0)
  contactSupportTimerMinutes Int @default(0)
  contactSupportActivatedAt DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("global_settings")
}

// ============= SUPPORT BOT (SEPARATE INBOX) =============
// These tables are intentionally separate from `User` so the support bot can
// register and chat with people who only launched the support bot.

model SupportChat {
  id              Int       @id @default(autoincrement())
  telegramId      String    @unique
  chatId          String    @unique
  username        String?
  firstName       String?
  lastName        String?
  status          String    @default("NEW")
  acceptedBy      String?
  acceptedAt      DateTime?
  funnelStageId   String?
  archivedAt      DateTime?
  isBlocked       Boolean   @default(false)
  blockedAt       DateTime?
  blockedBy       String?
  lastInboundAt   DateTime?
  lastOutboundAt  DateTime?
  startedAt       DateTime  @default(now())
  lastMessageAt   DateTime?
  lastMessageText String?
  unreadCount     Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  messages        SupportMessage[]
  notes           SupportNote[]
  broadcasts       SupportBroadcastRecipient[]

  @@index([lastMessageAt])
}

enum SupportBroadcastStatus {
  PENDING
  RUNNING
  CANCELLED
  COMPLETED
  FAILED
}

enum SupportBroadcastTarget {
  ALL
  STAGE
}

enum SupportBroadcastRecipientStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
  SKIPPED
}

model SupportBroadcast {
  id              Int       @id @default(autoincrement())
  adminUsername   String
  target          SupportBroadcastTarget
  stageId         String?
  text            String
  status          SupportBroadcastStatus @default(PENDING)
  totalRecipients Int       @default(0)
  sentCount       Int       @default(0)
  failedCount     Int       @default(0)
  startedAt       DateTime?
  completedAt     DateTime?
  cancelledAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  recipients      SupportBroadcastRecipient[]

  @@index([status, createdAt])
  @@index([adminUsername, createdAt])
}

model SupportBroadcastRecipient {
  id               Int       @id @default(autoincrement())
  broadcastId      Int
  broadcast        SupportBroadcast @relation(fields: [broadcastId], references: [id], onDelete: Cascade)

  supportChatId    Int
  supportChat      SupportChat @relation(fields: [supportChatId], references: [id], onDelete: Cascade)

  chatId           String
  status           SupportBroadcastRecipientStatus @default(PENDING)
  error            String?
  sentAt           DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([broadcastId, status])
  @@index([supportChatId])
}

model SupportNote {
  id            Int         @id @default(autoincrement())
  supportChatId Int
  supportChat   SupportChat @relation(fields: [supportChatId], references: [id], onDelete: Cascade)
  text          String
  adminUsername String?
  createdAt     DateTime    @default(now())

  @@index([supportChatId, createdAt])
}

model SupportMessage {
  id            Int         @id @default(autoincrement())
  supportChatId Int
  supportChat   SupportChat @relation(fields: [supportChatId], references: [id], onDelete: Cascade)
  direction     String
  kind          String      @default("TEXT")
  text          String?
  fileId        String?
  fileUniqueId  String?
  fileName      String?
  mimeType      String?
  adminUsername String?
  createdAt     DateTime    @default(now())

  @@index([supportChatId, createdAt])
}
