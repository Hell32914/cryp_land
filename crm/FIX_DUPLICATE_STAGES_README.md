# Исправление дублирующихся колонок воронки

## Проблема

После недавних обновлений воронки могли появиться дублирующиеся колонки. Например, могут существовать две колонки "Deposit" с разными ID, что приводит к разделению чатов между этими колонками.

## Решение

Создана утилита для автоматического объединения чатов из дублирующихся колонок и удаления дубликатов.

## Способы исправления

### 1. Через интерфейс CRM (рекомендуется)

1. Откройте CRM
2. В боковом меню выберите **"Исправить дубли"** (в разделе Support)
3. Нажмите кнопку **"Проверить на дубли"**
4. Если дубли найдены, нажмите **"Исправить дубликаты"**
5. Страница автоматически перезагрузится через 2 секунды

### 2. Через консоль браузера (быстрый способ)

1. Откройте CRM
2. Откройте консоль браузера (F12 → Console)
3. Выполните команду:
   ```javascript
   window.checkFunnelDuplicates()
   ```
4. Если дубли найдены, исправьте их:
   ```javascript
   window.fixFunnelDuplicates()
   ```
5. Страница автоматически перезагрузится через 2 секунды

### 3. Автоматическое исправление при загрузке (опционально)

Если вы хотите, чтобы дубли исправлялись автоматически при каждой загрузке приложения:

1. Откройте файл `crm/src/App.tsx`
2. Раскомментируйте импорт:
   ```typescript
   import { runAutoMigration } from '@/lib/auto-fix-duplicates'
   ```
3. Раскомментируйте useEffect в функции AppContent:
   ```typescript
   useEffect(() => {
     if (isAuthenticated) {
       runAutoMigration()
     }
   }, [isAuthenticated])
   ```
4. Миграция запустится автоматически при следующей загрузке
5. После успешного исправления миграция больше не будет запускаться (флаг сохраняется в localStorage)

Для сброса флага миграции (например, для повторного запуска):
```javascript
window.resetDuplicatesMigration()
```

## Как это работает

### Канонизация ID

Все ID колонок нормализуются к каноническому виду:
- Переводятся в нижний регистр
- Пробелы и подчеркивания заменяются на дефисы
- Удаляются недопустимые символы
- Ограничиваются 64 символами

Примеры:
- `"Deposit"` → `"deposit"`
- `"First Touch"` → `"first-touch"`
- `"Not Active 1"` → `"not-active-1"`
- `"deposit-123"` → `"deposit-123"` (но будет считаться дублем `"deposit"`)

### Процесс исправления

1. **Поиск дублей**: Находит все колонки с одинаковым каноническим ID
2. **Объединение чатов**: Все чаты из дублирующихся колонок переводятся на канонический ID
3. **Удаление дублей**: Дублирующиеся колонки удаляются, остается только одна с каноническим ID

## Файлы

### Основные файлы
- `crm/src/lib/fix-duplicate-stages.ts` - Логика поиска и исправления дублей
- `crm/src/lib/auto-fix-duplicates.ts` - Автоматическая миграция при загрузке
- `crm/src/lib/window-fix-duplicates.ts` - Утилиты для консоли браузера
- `crm/src/components/pages/FixDuplicateStages.tsx` - UI страница для исправления
- `crm/FIX_DUPLICATE_STAGES_README.md` - Эта документация

### Изменения в существующих файлах
- `crm/src/App.tsx` - Добавлен роут для страницы исправления и опциональная автомиграция
- `crm/src/components/Layout.tsx` - Добавлен пункт меню "Исправить дубли"
- `crm/src/lib/i18n.ts` - Добавлены переводы для нового пункта меню (EN, RU, UA)

## Безопасность

⚠️ **Внимание**: Исправление дублей необратимо!

Рекомендации:
1. Перед исправлением сделайте резервную копию данных
2. Экспортируйте настройки воронки (если такая функция доступна)
3. Проверьте список дублей перед исправлением
4. При необходимости можно восстановить данные из localStorage вручную

## Восстановление данных (если что-то пошло не так)

Если нужно откатить изменения:

1. Откройте консоль браузера (F12)
2. Восстановите старые данные из резервной копии:
   ```javascript
   // Пример восстановления (замените данные на свои из резервной копии)
   localStorage.setItem('crm.support.funnelStages.v1', 'ваши_старые_данные')
   localStorage.setItem('crm.support.chatStageMap.v1', 'ваши_старые_данные')
   window.location.reload()
   ```

## Предотвращение дублей в будущем

Функция `dedupeStages()` в `support-funnel.ts` автоматически предотвращает создание дублей при сохранении. Однако дубли могли появиться из-за миграции данных или ручного редактирования localStorage.

## Поддержка

Если возникли проблемы:
1. Проверьте консоль браузера на наличие ошибок
2. Убедитесь, что используете последнюю версию кода
3. Обратитесь к разработчикам с логами из консоли
